<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>排班系统</title>
    <script src="https://cdn.bootcss.com/jquery/2.1.2/jquery.min.js"></script>
    <script src="js.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            padding: 60px;
        }

        table {
            width: 100%;
            table-layout: fixed;
            text-align: center;
        }

        thead {
            width: 100%;
        }

        tr {
            width: 100%;
            height: 50px;
        }

        th {
            border: 1px solid #000000;
            word-break: break-word;
        }

        td {
            border: 1px solid #000000;
            word-break: break-word;
        }

        table input {
            width: 70%;
        }

        label {
            display: inline-block;
            width: 15%;
            text-align: right;
            margin-right: 20px;
        }

        input {
            width: 70%;
            height: 30px;
            line-height: 30px;
            padding: 0 10px;
        }

        button {
            margin-left: calc(15% + 25px);
            background: #8a8a8a;
            border: 0;
            color: #ffffff;
            padding: 10px;
            cursor: pointer;
        }

        button:hover {
            background: #6e6e6e;
            cursor: pointer;
        }

        h4, li {
            margin-left: calc(15% + 25px);
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
<h2>排班系统</h2>
<h4>系统注明：</h4>
<ul>
    <li>系统会自动将每人每周3班+4班次数<=3</li>
    <li>夜2班的人员不会安排到正0里面</li>
    <li>前一天休息的人会优先安排到下一天的正0班</li>
</ul>
<br>
<div>
    <label for="peopleTotal">请输入总人数:</label>
    <input type="number" id="peopleTotal">
</div>
<br>
<div>
    <label for="endPeople">请输入最后一天的夜2班人:</label>
    <input type="text" id="endPeople">
</div>
<br>
<div>
    <label for="peopleCount">请输入排班数量:</label>
    <input type="text" id="peopleCount" placeholder="每天输入4个，总共输入28个，用英文逗号隔开，最后不用加逗号，为了防止你想重新排班的时候又要重新输入">
</div>
<br>
<button id="ok" type="button">确定这样排班</button>

<!--<div>请输入休息剩余人:-->
<!--<input type="number">-->
<!--</div>-->
<br>
<!--<form>-->
<!--<table id="table1" cellpadding="0" cellspacing="0">-->
<!--<thead>-->
<!--<tr>-->
<!--<th></th>-->
<!--<th>正0</th>-->
<!--<th>正2</th>-->
<!--<th>夜1</th>-->
<!--<th>夜2</th>-->
<!--<th>休息</th>-->
<!--</thead>-->
<!--<tbody>-->
<!--<tr>-->
<!--<td>周一</td>-->
<!--<td><input type="text" name="1_1"></td>-->
<!--<td><input type="text" name="1_2"></td>-->
<!--<td><input type="text" name="1_3"></td>-->
<!--<td><input type="text" name="1_4"></td>-->
<!--<td></td>-->
<!--</tr>-->
<!--<tr>-->
<!--<td>周二</td>-->
<!--<td><input type="text" name="2_1"></td>-->
<!--<td><input type="text" name="2_2"></td>-->
<!--<td><input type="text" name="2_3"></td>-->
<!--<td><input type="text" name="2_4"></td>-->
<!--<td></td>-->
<!--</tr>-->
<!--<tr>-->
<!--<td>周三</td>-->
<!--<td><input type="text" name="3_1"></td>-->
<!--<td><input type="text" name="3_2"></td>-->
<!--<td><input type="text" name="3_3"></td>-->
<!--<td><input type="text" name="3_4"></td>-->
<!--<td></td>-->

<!--</tr>-->
<!--<tr>-->
<!--<td>周四</td>-->
<!--<td><input type="text" name="4_1"></td>-->
<!--<td><input type="text" name="4_2"></td>-->
<!--<td><input type="text" name="4_3"></td>-->
<!--<td><input type="text" name="4_4"></td>-->
<!--<td></td>-->

<!--</tr>-->
<!--<tr>-->
<!--<td>周五</td>-->
<!--<td><input type="text" name="5_1"></td>-->
<!--<td><input type="text" name="5_2"></td>-->
<!--<td><input type="text" name="5_3"></td>-->
<!--<td><input type="text" name="5_4"></td>-->
<!--<td></td>-->

<!--</tr>-->
<!--<tr>-->
<!--<td>周六</td>-->
<!--<td><input type="text" name="6_1"></td>-->
<!--<td><input type="text" name="6_2"></td>-->
<!--<td><input type="text" name="6_3"></td>-->
<!--<td><input type="text" name="6_4"></td>-->
<!--<td></td>-->

<!--</tr>-->
<!--<tr>-->
<!--<td>周日</td>-->
<!--<td><input type="text" name="7_1"></td>-->
<!--<td><input type="text" name="7_2"></td>-->
<!--<td><input type="text" name="7_3"></td>-->
<!--<td><input type="text" name="7_4"></td>-->
<!--<td></td>-->

<!--</tr>-->
<!--</tbody>-->
<!--</table>-->
<!--<br>-->
<!--<br>-->

<!--</form>-->


<br>
<br>
<table id="table2" cellpadding="0" cellspacing="0">
    <thead>
    <tr>
        <th></th>
        <th>正0</th>
        <th>正2</th>
        <th>夜1</th>
        <th>夜2</th>
        <th>休息</th>
    </thead>
    <tbody>
    <tr>
        <td>周一</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>周二</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>周三</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    <tr>
        <td>周四</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    <tr>
        <td>周五</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    <tr>
        <td>周六</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    <tr>
        <td>周日</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    </tbody>
</table>
<br>
<br>
<div>最后一天的夜2班人为：<span id="tArr4"></span></div>
<!--<div>休息剩余人为：</div>-->

<script>
    /**
     *
     * 2018/5/25 更新
     * 现在采用每次休息人记录到XXArr中，然后每天分配时，然后从xxArr中拷贝数组，从拷贝数组中分配掉，
     * 这样就会优先分配休息过的，剩下的就可以正常休息了
     *
     * 2018/5/16 更新
     * 周一，先把周一休息的人存起来；然后周二优先将这几个人在正0中分配出去，如果没分配完，分配到下一个班里面去；
     * 如果是周日，将周日休息的人保存下来，在下次排班时输入周日休息的人，会在下周一优先分配
     * (优化：可以按照上面的算法来排，如果存满总人数了，表明每人都休息过一次了，然后重新开档，再往里存，
     * 如果还是超过，同上，如果没超过，那就把这里面的人保存下来，在下次排版时输入这个休息两天+的人，下周就会先给剩下的人休息，
     * 这样剩下的人就会有很大几率休息两天了，前提是这周与上周的工作量相同)
     */
</script>
<script>
    let serializeVal;
    $('#ok').click(function () {

        // serializeVal = $("form").serialize();
        // let serializeArr = serializeVal.split('&');
        // for (let i = 0; i < serializeArr.length; i++) {
        //     arr1.push(serializeArr[i].split('=')[1]);
        // }
        // let peopleTotal = $('#peopleTotal').val();
        // let endPeople = $('#endPeople').val();

        // let serializeArr = $('#peopleCount').split(',');
        // for (let i = 0; i < serializeArr.length; i++) {
        //     arr1.push(serializeArr[i].split('=')[1]);
        // }
        // peopleTotal = $('#peopleTotal').val();
        // endPeople = $('#endPeople').val();
        let arr1 = [];
        let peopleTotal;
        let endPeople;
        arr1 = [8, 4, 4, 8, 9, 5, 4, 10, 9, 5, 4, 10, 9, 5, 4, 10, 8, 5, 3, 9, 8, 4, 3, 9, 8, 4, 3, 9];
        peopleTotal = 30;
        endPeople = '1,2,7,10,13,14,15,20,24';
        calculate(peopleTotal, arr1, endPeople);
    });

    /**
     * 排班计算类
     * @param peopleTotal 总人数
     * @param arr1 表单计算出的人数数组
     * @param end 最后一天的夜2班人
     */
    function calculate(peopleTotal, arr1, end) {
        arr1 = numSplit(arr1);
        let peopleTotalArr = [];
        //生成总人数序列
        for (let i = 1; i <= peopleTotal; i++) {
            peopleTotalArr[i - 1] = i;
        }

        let tArr4;//最后一天夜2班的人
        let tArr3 = [];//每次夜2班的人
        let y12Arr = [];//所有上夜班的人记录
        let y12ArrTemp = [];//所有上夜班的人记录临时变量
        let xxArrTemp = [];//休息人临时数组
        let xxArr = [];//休息人数组
        let endArr = end.split(',');//最后一天的夜2班人数组
        let _peopleTotalArr4 = [...peopleTotalArr];//用作排除掉上周夜2班的人，剩下的人用来排第一天的正0

        for (let x = 0; x < endArr.length; x++) {
            endArr[x] = parseInt(endArr[x]);
        }
        for (let x = 0; x < endArr.length; x++) {
            _peopleTotalArr4.remove(endArr[x]);
        }
        for (let i = 0; i < arr1.length; i++) {
            let _peopleTotalArr = [...peopleTotalArr];
            let _peopleTotalArr3 = [...peopleTotalArr];
            let _peopleTotalArr5 = [...peopleTotalArr];
            for (let j = 0; j < arr1[i].length; j++) {
                if (i === 0) {
                    //如果是第一天
                    let a;
                    //如果填了上周最后一天夜2班的人
                    if (end) {
                        if (j === 0) {
                            a = getArrayItems(_peopleTotalArr4, arr1[i][j]);
                            for (let x = 0; x < a.length; x++) {
                                _peopleTotalArr.remove(a[x]);
                            }
                        } else {
                            a = getArrayItems(_peopleTotalArr, arr1[i][j]);
                        }
                    }
                    //把生成的人填到表格里面去
                    htmltable(i, j + 1, a);

                    //console.log(a);
                    //如果是第一天的夜2班，将剩下的人填到表格里去
                    if (j === 3) {
                        htmltable(i, 5, _peopleTotalArr);

                        //console.log(_peopleTotalArr);
                        tArr3 = [...a];//将每次夜2班的人填到数组中，用来在后一天判断不分配到正0里面去
                        xxArr = [..._peopleTotalArr];//休息人总数组，用来记录已经休息的人，保证每个人都是至少休息一次
                        xxArrTemp = [...xxArr];
                    }
                    if (j === 2 || j === 3) {//记录所有上夜班的人
                        y12ArrTemp = [...y12Arr, ...a];
                        y12Arr = [];
                        y12Arr = [...y12ArrTemp];
                    }
                } else {
                    //如果不是第一天
                    let aa = [];
                    //上一个夜2班的人不安排到正0班里
                    if (j === 0) {

                        let y2 = [...tArr3];//上一个夜2班的人
                        //移除上一个夜2班的人

                        if (arr1[i][j] >= xxArrTemp.length) {//如果今天这个班需要的人数大于前一天休息的人数，那么就直接把休息人分配进去就行了，反之往下一个班分配
                            for (let k = 0; k < xxArrTemp.length; k++) {
                                aa.push(xxArrTemp[k]);
                            }
                            xxArrTemp = [];//如果分配完了就直接清空就是了
                            //去除掉上夜2班的人
                            for (let x = 0; x < y2.length; x++) {
                                _peopleTotalArr5.remove(y2[x]);
                            }
                            //去除掉已经分配的人
                            for (let x = 0; x < aa.length; x++) {
                                _peopleTotalArr5.remove(aa[x]);
                            }
                            // todo 现在采用每次休息人记录到XXArr中，然后每天分配时，然后从xxArr中拷贝数组，从拷贝数组中分配掉，这样就会优先分配休息过的，剩下的就可以正常休息了
                            // todo 目前已经将XXArr的值赋值给XXArrTemp 这样就是从总休息人数数组里面进行分配了
                            let aaTemp = [];
                            aaTemp = [...aa, ...getArrayItems(_peopleTotalArr5, arr1[i][j] - aa.length)];
                            aa = [];
                            aa = [...aaTemp];

                        } else {
                            //如果这个班需要的人小于前一天休息的人数，那就直接分配掉，然后XXArrTemp删除刚才分配掉的人，这时候里面肯定是还有人的，放在下一个班分配
                            let xxArrTempRemove = [];
                            for (let k = 0; k < arr1[i][j]; k++) {
                                aa.push(xxArrTemp[k]);
                                xxArrTempRemove.push(xxArrTemp[k]);
                            }
                            for (let k = 0; k < arr1[i][j]; k++) {
                                xxArrTemp.remove(xxArrTempRemove[k]);
                            }
                            xxArrTempRemove = [];
                        }

                        htmltable(i, j + 1, aa);
                        //console.log(aa);
                        for (let y = 0; y < aa.length; y++) {
                            _peopleTotalArr3.remove(aa[y]);
                        }
                        console.log(aa)

                    } else {
                        //如果还剩休息过的人，也就是在正0里面没分配完的,需要在下面的班里面给分配完
                        if (arr1[i][j] >= xxArrTemp.length) {
                            for (let k = 0; k < xxArrTemp.length; k++) {
                                aa.push(xxArrTemp[k]);
                            }
                            xxArrTemp = [];
                            //去除掉已经分配的人
                            for (let x = 0; x < aa.length; x++) {
                                _peopleTotalArr3.remove(aa[x]);
                            }

                            if (j === 2 || j === 3) {
                                let aaTemp = [];
                                let ybTemp = yb((arr1[i][j] - aa.length), _peopleTotalArr3, y12Arr);
                                console.log(`${arr1[i][j]}------------${y12Arr}---------------${ybTemp}`);
                                aaTemp = [...aa, ...ybTemp];
                                aa = [];
                                aa = [...aaTemp];
                            } else {
                                let aaTemp = [];
                                aaTemp = [...aa, ...getArrayItems(_peopleTotalArr3, arr1[i][j] - aa.length)];
                                aa = [];
                                aa = [...aaTemp];
                            }
                            console.log(aa)

                        } else {
                            let xxArrTempRemove = [];
                            for (let k = 0; k < arr1[i][j]; k++) {
                                aa.push(xxArrTemp[k]);
                                xxArrTempRemove.push(xxArrTemp[k]);
                            }
                            for (let k = 0; k < arr1[i][j]; k++) {
                                xxArrTemp.remove(xxArrTempRemove[k]);
                            }
                            xxArrTempRemove = [];
                        }
                        htmltable(i, j + 1, aa);

                        //console.log(aa);
                        if (j === 3) {
                            htmltable(i, 5, _peopleTotalArr3);
                            //console.log(_peopleTotalArr3);
                            let t = [...xxArr, ..._peopleTotalArr3];
                            xxArr = [...t];//休息人总数组，用来记录已经休息的人，保证每个人都是至少休息一次
                            xxArrTemp = [...xxArr];
                        }

                        if (i === (arr1.length - 1) && j === 3) {//将最后一天的最后一个上夜2班的人找出来显示
                            tArr4 = [...aa];
                            let html2 = $('#tArr4').html();
                            if (html2) {
                                $('#tArr4').html(`${html2},${tArr4}`);
                            } else {
                                $('#tArr4').html(`${tArr4}`);
                            }
                        }
                        if (j === 2 || j === 3) {//如果是夜班，就把人添加到数组里面去
                            let temp = [...y12Arr, ...aa];
                            y12Arr = [];
                            y12Arr = [...temp];
                        }
                    }


                }

            }
        }
    }


</script>
<br>
<br>
<br>
<br>
<br>
<br>
</body>
</html>