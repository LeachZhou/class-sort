<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>排班系统</title>
    <script src="https://cdn.bootcss.com/jquery/2.1.2/jquery.min.js"></script>
    <script src="js.js"></script>
    <style>
        table {
            width: 100%;
            table-layout: fixed;
            text-align: center;
        }

        thead {
            width: 100%;
        }

        tr {
            width: 100%;
            height: 50px;
        }

        th {
            border: 1px solid #000000;
            word-break: break-word;
        }

        td {
            border: 1px solid #000000;
            word-break: break-word;
        }

        table input {
            width: 70%;
        }
    </style>
</head>
<body>
<!--<h2>排班系统</h2>-->
<p>注：每人每周3班+4班<=3</p>
<br>
<div>请输入总人数: <input type="number" id="peopleTotal">
</div>
<div>请输入最后一天的夜2班人: <input type="text" id="endPeople">
</div>
<br>
<div>请输入休息剩余人: <input type="number">
</div>
<br>
<form>
    <table id="table1" cellpadding="0" cellspacing="0">
        <thead>
        <tr>
            <th></th>
            <th>正0</th>
            <th>正2</th>
            <th>夜1</th>
            <th>夜2</th>
            <th>休息</th>
        </thead>
        <tbody>
        <tr>
            <td>周一</td>
            <td><input type="text" name="1_1"></td>
            <td><input type="text" name="1_2"></td>
            <td><input type="text" name="1_3"></td>
            <td><input type="text" name="1_4"></td>
            <td></td>
        </tr>
        <tr>
            <td>周二</td>
            <td><input type="text" name="2_1"></td>
            <td><input type="text" name="2_2"></td>
            <td><input type="text" name="2_3"></td>
            <td><input type="text" name="2_4"></td>
            <td></td>
        </tr>
        <tr>
            <td>周三</td>
            <td><input type="text" name="3_1"></td>
            <td><input type="text" name="3_2"></td>
            <td><input type="text" name="3_3"></td>
            <td><input type="text" name="3_4"></td>
            <td></td>

        </tr>
        <tr>
            <td>周四</td>
            <td><input type="text" name="4_1"></td>
            <td><input type="text" name="4_2"></td>
            <td><input type="text" name="4_3"></td>
            <td><input type="text" name="4_4"></td>
            <td></td>

        </tr>
        <tr>
            <td>周五</td>
            <td><input type="text" name="5_1"></td>
            <td><input type="text" name="5_2"></td>
            <td><input type="text" name="5_3"></td>
            <td><input type="text" name="5_4"></td>
            <td></td>

        </tr>
        <tr>
            <td>周六</td>
            <td><input type="text" name="6_1"></td>
            <td><input type="text" name="6_2"></td>
            <td><input type="text" name="6_3"></td>
            <td><input type="text" name="6_4"></td>
            <td></td>

        </tr>
        <tr>
            <td>周日</td>
            <td><input type="text" name="7_1"></td>
            <td><input type="text" name="7_2"></td>
            <td><input type="text" name="7_3"></td>
            <td><input type="text" name="7_4"></td>
            <td></td>

        </tr>
        </tbody>
    </table>
    <br>
    <br>

</form>
<div style="text-align: center;">
    <button id="ok" type="button">确定这样排班</button>
</div>


<br>
<br>
<table id="table2" cellpadding="0" cellspacing="0">
    <thead>
    <tr>
        <th></th>
        <th>正0</th>
        <th>正2</th>
        <th>夜1</th>
        <th>夜2</th>
        <th>休息</th>
    </thead>
    <tbody>
    <tr>
        <td>周一</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>周二</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>周三</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    <tr>
        <td>周四</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    <tr>
        <td>周五</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    <tr>
        <td>周六</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    <tr>
        <td>周日</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

    </tr>
    </tbody>
</table>
<br>
<br>
<div>最后一天的夜2班人为：<span id="tArr4"></span></div>
<div>休息剩余人为：</div>

<script>
    let serializeVal;
    $('#ok').click(function () {
        var arr1 = [];
        serializeVal = $("form").serialize();
        let serializeArr = serializeVal.split('&');
        for (let i = 0; i < serializeArr.length; i++) {
            arr1.push(serializeArr[i].split('=')[1]);
        }
        // arr1 = [4, 5, 9, 9, 6, 8, 7, 5, 5, 7, 8, 6, 9, 9, 5, 4, 3, 9, 8, 7, 8, 7, 3, 9, 5, 5, 9, 7];
        let peopleTotal = $('#peopleTotal').val();
        let endPeople = $('#endPeople').val();
        calculate(peopleTotal, arr1, endPeople);
    });

    /**
     * 排班计算类
     * @param peopleTotal 总人数
     * @param arr1 表单计算出的人数数组
     * @param end 最后一天的夜2班人
     */
    function calculate(peopleTotal, arr1, end) {
        arr1 = numSplit(arr1);
        var peopleTotalArr = [];
        //生成总人数序列
        for (let i = 1; i <= peopleTotal; i++) {
            peopleTotalArr[i - 1] = i;
        }

        let tArr4;//最后一天夜2班的人
        let tArr3 = [];//每次夜2班的人
        let y12Arr = [];//所有上夜班的人记录
        let y12ArrTemp = [];//所有上夜班的人记录临时变量
        for (let i = 0; i < arr1.length; i++) {
            let _peopleTotalArr = [...peopleTotalArr];
            let _peopleTotalArr2 = [...peopleTotalArr];
            let _peopleTotalArr3 = [...peopleTotalArr];
            let _peopleTotalArr4 = [...peopleTotalArr];
            for (let j = 0; j < arr1[i].length; j++) {
                if (i == 0) {
                    //如果是第一天
                    let a;
                    if (!end) {
                        a = getArrayItems(_peopleTotalArr, arr1[i][j]);
                    } else {
                        let endArr = end.split(',');
                        for (let x = 0; x < endArr.length; x++) {
                            _peopleTotalArr4.remove(endArr[x]);
                        }
                        a = getArrayItems(_peopleTotalArr4, arr1[i][j]);

                    }
                    let html = $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html();
                    if (html) {
                        $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html(`${html},${a}`);
                    } else {
                        $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html(`${a}`);
                    }
                    console.log(a);
                    if (j == 3) {
                        let html = $('#table2 tbody').find('tr').eq(i).find('td').eq(5).html();
                        if (html) {
                            $('#table2 tbody').find('tr').eq(i).find('td').eq(5).html(`${html},${_peopleTotalArr}`);
                        } else {
                            $('#table2 tbody').find('tr').eq(i).find('td').eq(5).html(`${_peopleTotalArr}`);
                        }
                        console.log(_peopleTotalArr);
                        tArr3 = [...a];
                    }
                    if (j == 2 || j == 3) {
                        y12ArrTemp = [...y12Arr, ...a];
                        y12Arr = [];
                        y12Arr = [...y12ArrTemp];
                    }
                } else {
                    //如果不是第一天
                    let aa = [];
                    //上一个夜2班的人不安排到正0班里
                    if (j == 0) {
                        let y2 = [...tArr3];//上一个夜2班的人
                        //移除上一个夜2班的人

                        for (let x = 0; x < y2.length; x++) {
                            _peopleTotalArr2.remove(y2[x]);
                        }
                        //夜1加夜2不能超过3次
                        for (let k = 0; k < arr1[i][j]; k++) {
                            let ran = Math.floor(Math.random() * _peopleTotalArr2.length);
                            let ranVal = _peopleTotalArr2[ran];
                            while (arrValNum3(y12Arr, ranVal)) {
                                ran = Math.floor(Math.random() * _peopleTotalArr2.length);
                                ranVal = _peopleTotalArr2[ran];
                            }
                            aa.push(_peopleTotalArr2.splice(ran, 1)[0]);
                        }
                        // aa = getArrayItems(_peopleTotalArr2, arr1[i][j]);
                        let html = $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html();
                        if (html) {
                            $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html(`${html},${aa}`);
                        } else {
                            $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html(`${aa}`);
                        }
                        console.log(aa);
                        for (let y = 0; y < aa.length; y++) {
                            _peopleTotalArr3.remove(aa[y]);
                        }
                    } else {
                        //夜1加夜2不能超过3次
                        for (let h = 0; h < arr1[i][j]; h++) {
                            let ran = Math.floor(Math.random() * _peopleTotalArr3.length);
                            let ranVal = _peopleTotalArr3[ran];
                            while (arrValNum3(y12Arr, ranVal)) {
                                ran = Math.floor(Math.random() * _peopleTotalArr3.length);
                                ranVal = _peopleTotalArr3[ran];
                            }
                            aa.push(_peopleTotalArr3.splice(ran, 1)[0]);
                        }
                        // aa = getArrayItems(_peopleTotalArr3, arr1[i][j]);
                        let html = $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html();
                        if (html) {
                            $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html(`${html},${aa}`);
                        } else {
                            $('#table2 tbody').find('tr').eq(i).find('td').eq(j + 1).html(`${aa}`);
                        }

                        console.log(aa);
                        if (j == 3) {
                            let html = $('#table2 tbody').find('tr').eq(i).find('td').eq(5).html();
                            if (html) {
                                $('#table2 tbody').find('tr').eq(i).find('td').eq(5).html(`${html},${_peopleTotalArr3}`);
                            } else {
                                $('#table2 tbody').find('tr').eq(i).find('td').eq(5).html(`${_peopleTotalArr3}`);
                            }
                            console.log(_peopleTotalArr3);
                        }
                        if (i == (arr1.length - 1)) {
                            if (j == 3) {
                                tArr4 = aa;
                                let html2 = $('#tArr4').html();
                                if (html2) {
                                    $('#tArr4').html(`${html2},${tArr4}`);
                                } else {
                                    $('#tArr4').html(`${tArr4}`);
                                }
                            }
                        }
                    }
                    if (j == 2 || j == 3) {
                        y12Arr = [...y12Arr, ...aa];
                        y12Arr = [];
                        y12Arr = [...y12ArrTemp];
                    }
                }

            }
        }
        console.log(y12Arr);
    }


</script>
<br>
<br>
<br>
<br>
<br>
<br>
</body>
</html>